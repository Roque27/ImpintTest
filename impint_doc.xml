<?xml version="1.0" encoding="iso-8859-1"?>
<qry:doc-definition xmlns:qry="lg.lan/qry" name="ejemplo simple">
    <qry:declare>

        <!-- Variables globales -->
        <qry:variable name="Imputacion_Incobrables" type="integer" value="0"/>
        <qry:variable name="OrdenDesde" type="integer" value="9999999"/>
        <qry:variable name="OrdenHasta" type="integer" value="0"/>
        <qry:variable name="sec_codigo" type="string" value="0"/>
        <qry:variable name="tor_grupo" type="integer" value="0"/>
        <qry:variable name="hay_datos_geograficos" type="integer" value="0"/>
        <qry:variable name="psal" type="integer" value="0"/>
        <qry:variable name="not_codigo" type="string"/>

        <qry:variable name="Tor_codigo" type="string"/>
        <qry:variable name="s_srv_agf_nombre" type="string"/>
        <qry:variable name="sysdate" type="string"/>
        
        <qry:variable name="l_usr_numero" type="integer"/>
        <qry:variable name="l_tim_codigo" type="string"/>
        <qry:variable name="l_crr_genera_planilla" type="string"/>
        <qry:variable name="l_crr_archivo_lote" type="string"/>
        <qry:variable name="l_crr_archivo_lote_path" type="string"/>
        <qry:variable name="l_cpr_numero" type="integer"/>
        <qry:variable name="l_est_codigo" type="string"/>
        <qry:variable name="l_prox_est_codigo" type="string"/>
        <qry:variable name="l_o_prs_numero" type="string"/>
        
        <qry:variable name="Escribi" type="integer" value="0"/>
        <qry:variable name="domicilio_fiscal_full" type="string" value=""/>
        <qry:variable name="bar_code" type="string"/>
        <qry:variable name="nro_ord" type="integer"/>
        <qry:variable name="nrobarra" type="integer"/>
        <qry:variable name="srv_cod" type="integer"/>
        <qry:variable name="cnt_num" type="integer"/>
        <qry:variable name="trt_num" type="integer"/>

        <qry:variable name="ban" type="integer"/>

        <!-- Bucle principal -->

        <qry:variable name="prs_num" type="string"/> <!-- OK -->
        <qry:variable name="prs_razon_social" type="string"/>
        <qry:variable name="prs_direccion" type="string"/>
        <qry:variable name="cfc_codigo" type="string"/>
        <qry:variable name="prs_calle" type="string"/>
        <qry:variable name="prs_nro" type="string"/>
        <qry:variable name="prs_piso" type="string"/>
        <qry:variable name="prs_depto" type="string"/>
        <qry:variable name="prs_torreo" type="string"/>
        <qry:variable name="prs_c_postal" type="string"/>
        <qry:variable name="prs_agf_nombre" type="string"/>
        <qry:variable name="cll_nombre" type="string"/>
        <qry:variable name="cnt_nro_pago" type="string"/>
        <qry:variable name="cnt_bis" type="string"/>
        <qry:variable name="cnt_piso_pago" type="string"/>
        <qry:variable name="cnt_depto_pago" type="string"/>
        <qry:variable name="cnt_c_postal_pago" type="string"/>
        <qry:variable name="cnt_agf_nombre" type="string"/>
        <qry:variable name="cll_nombre_completo" type="string"/>

        <!-- Estructuras llenas -->

        <qry:variable name="TBL_documentos" type="data"/>
        <qry:variable name="TBL_personas" type="data"/>
        <qry:variable name="TBL_contratos" type="data"/>
        <qry:variable name="TBL_servicios" type="data"/>
        <qry:variable name="TBL_lecturas" type="data"/>
        <qry:variable name="TBL_ordenativos" type="data"/>
        <qry:variable name="TBL_potencias" type="data"/>
        <qry:variable name="TBL_stock_equipos" type="data"/>
        <qry:variable name="TBL_sucursales" type="data"/>
        <qry:variable name="TBL_bancos" type="data"/>
        <qry:variable name="TBL_cargos" type="data"/>
        <qry:variable name="TBL_tarifas" type="data"/>
        <qry:variable name="TBL_tipos_iva" type="data"/>
        <qry:variable name="TBL_totales_tramites" type="data"/>

        <!-- Banderas estructuras llenas -->

        <qry:variable name="actual_prs_numero" type="integer"/>
        <qry:variable name="actual_srv_cod" type="integer"/>
        <qry:variable name="actual_scf_cod" type="integer"/>
        <qry:variable name="actual_nro_ord" type="integer"/>
        <qry:variable name="actual_agf_cod" type="integer"/>
        <qry:variable name="actual_ivv_cod" type="integer"/>
        <qry:variable name="actual_tcl_cod" type="integer"/>
        <qry:variable name="actual_trt_num" type="integer"/>

        <qry:variable name="isEmpty_documentos_doc" type="integer" value="0"/>
        <qry:variable name="isEmpty_documentos_ori" type="integer" value="0"/>
        <qry:variable name="isEmpty_personas" type="integer" value="0"/>
        <qry:variable name="isEmpty_contratos" type="integer" value="0"/>
        <qry:variable name="isEmpty_servicios" type="integer" value="0"/>
        <qry:variable name="isEmpty_lecturas" type="integer" value="0"/>
        <qry:variable name="isEmpty_ordenativos" type="integer" value="0"/>
        <qry:variable name="isEmpty_potencias" type="integer" value="0"/>
        <qry:variable name="isEmpty_stock_equipos" type="integer" value="0"/>
        <qry:variable name="isEmpty_sucursales" type="integer" value="0"/>
        <qry:variable name="isEmpty_bancos" type="integer" value="0"/>
        <qry:variable name="isEmpty_cargos" type="integer" value="0"/>
        <qry:variable name="isEmpty_tarifas" type="integer" value="0"/>
        <qry:variable name="isEmpty_tipos_iva" type="integer" value="0"/>
        <qry:variable name="isEmpty_totales_tramites" type="integer" value="0"/>

        <!-- Notifi -->
        
        <qry:variable name="v_columna" type="string"/>
        <qry:variable name="largos" type="integer" value="0"/>
        <qry:variable name="campo" type="string"/>
        <qry:variable name="l_tor_descripcion" type="string"/>
        <qry:variable name="document_tbl_type" type="string"/>
        <qry:variable name="eno_col" type="double"/>

        <qry:variable name="srv_cod_temp" type="integer"/>
        <qry:variable name="cnt_num_temp" type="integer"/>
        <qry:variable name="trt_num_temp" type="integer"/>
        <qry:variable name="prs_num_temp" type="integer"/>

        <qry:variable name="v_tabla" type="string"/>
        <qry:variable name="v_columna" type="string"/>

        <!-- Personas -->

        <!-- Contratos -->
        <qry:variable name="ivv_codigo" type="string"/>
        <qry:variable name="tcl_cod" type="string"/>

        <!-- Servicios -->

        <!-- Lecturas -->

        <!-- Ordenativos -->

        <!-- Potencias -->
        
        <!-- Sucursales -->
        <qry:variable name="scf_cod" type="integer"/>

        <!-- Bancos -->
        <qry:variable name="agf_cod" type="integer"/>

        <!-- Cargos -->
        <qry:variable name="v_descripcion" type="string"/>
        <qry:variable name="v_ord_fec" type="string"/>
        
        <!-- Tipos_IVA -->
        <qry:variable name="ivv_cod" type="integer"/>

        <!-- Tarifas -->

        <!-- Documentos -->
        <qry:variable name="t_doc_saldo" type="integer" value="0"/>
        <qry:variable name="num_rows_doc" type="integer" value="20"/>  <!-- El valor ya esta hardcodeado -->
        <qry:variable name="nro_linea" type="integer" value="0"/>
        <qry:variable name="Tiene_Comprobantes_Financiaciones" type="integer" value="0"/>
        <qry:variable name="Tiene_Otros_Comprobantes" type="integer" value="0"/>
        <qry:variable name="CantidadDeFacturas" type="integer" value="0"/>
        <qry:variable name="ImporteDelAviso" type="double" value="0"/>

        <!-- Totales_Tramite -->
        
        <!-- Usuarios -->
        
        <!-- Prs_Num_Ori -->
        <qry:variable name="cnt_num_ori" type="integer"/>
        <qry:variable name="srv_cod_ori" type="integer"/>

        <!-- SelectCodigoBarras -->
        
        <!-- Buscar_Codigos_Control -->
        <qry:variable name="v_tim_codigo" type="string"/>
  
    </qry:declare>
    <qry:main>
         <!-- No posee select propio -->
        <qry:out>
            
            <qry:element name="raiz">
              <!--<qry:element name="PARAMETROS">
                <qry:attribute name="NOMBREARCHIVO" value="#PARAM:/IMPINT_PARAM/NOMBREARCHIVO/@PARAMFILE"/>
                <qry:attribute name="REPORTE" value="#PARAM:/IMPINT_PARAM/REPORTE/@PARAMREPCODIGO"/>
                <qry:attribute name="INCOBRABLES" value="#PARAM:/IMPINT_PARAM/INCOBRABLES/@PARAMINCOBRABLES"/>
                <qry:attribute name="USER" value="#PARAM:/IMPINT_PARAM/USER/@PARAMUSER"/>
                <qry:attribute name="PRINT" value="#PARAM:/IMPINT_PARAM/PRINT/@PARAMIMPR"/>
                <qry:attribute name="TIPOCORREO" value="#PARAM:/IMPINT_PARAM/TIPOCORREO/@PARAMCODTIPOCORREO" />
                <qry:attribute name="CORREO" value="#PARAM:/IMPINT_PARAM/CORREO/@PARAMCODCORREO" />
                <qry:attribute name="TOR_CODIGO" value="#PARAM:/IMPINT_PARAM/TOR_CODIGO/@PARAMTORCOD" />
                <qry:attribute name="SUC" value="#PARAM:/IMPINT_PARAM/SUC/@PARAMSUC" />
                <qry:attribute name="SEC" value="#PARAM:/IMPINT_PARAM/SEC/@PARAMSEC" />
                <qry:attribute name="ORD_DESDE" value="#PARAM:/IMPINT_PARAM/ORD_DESDE/@PARAMORDDSD" />
                <qry:attribute name="ORD_HASTA" value="#PARAM:/IMPINT_PARAM/ORD_HASTA/@PARAMORDHST"/>
              </qry:element> -->
              <qry:insert-query name="Main" doc-param="#PARAM:"/>
              
            </qry:element>
        </qry:out>
    </qry:main>

    <!-- MAIN -->
    
    <qry:query name="Main">
        <qry:select>
            SELECT o.trt_numero
              ,o.ord_numero
              ,o.srv_codigo AS SRV_CODIGO
              ,o.cnt_numero
              ,nvl(o.tor_codigo, '')
              ,to_char(o.ord_fecha_generacion, 'dd/mm/yyyy') AS ORD_FECHA_GENERACION
              ,u.scf_codigo
              ,COALESCE(o.sec_codigo_origen, '0') AS SEC_CODIGO_ORIGEN
              ,COALESCE(t.tor_grupo, '0') AS TOR_GRUPO
              ,t.tor_descripcion
              ,COALESCE(o.prs_numero, 0) AS PRS_NUMERO
              ,o.rowid
              ,o.crr_tipo
              ,o.crr_codigo
            FROM ordenativos o
            INNER JOIN tipos_ordenativo t
                  ON o.tor_codigo = t.tor_codigo
            CROSS JOIN usuarios u
            WHERE t.tor_codigo = {#PARAM:/IMPINT_PARAM/TOR_CODIGO/@PARAMTORCOD}
              AND u.usr_codigo = {#PARAM:/IMPINT_PARAM/USER/@PARAMUSER}
              AND o.scf_codigo_origen = {#PARAM:/IMPINT_PARAM/SUC/@PARAMSUC}
              AND o.sec_codigo_origen = {#PARAM:/IMPINT_PARAM/SEC/@PARAMSEC}
              AND o.ord_numero BETWEEN {#PARAM:/IMPINT_PARAM/ORD_DESDE/@PARAMORDDSD} AND {#PARAM:/IMPINT_PARAM/ORD_HASTA/@PARAMORDHST}
              AND o.crr_tipo = {#PARAM:/IMPINT_PARAM/TIPOCORREO/@PARAMCODTIPOCORREO}
              AND o.crr_codigo = {#PARAM:/IMPINT_PARAM/CORREO/@PARAMCODCORREO}
              AND o.ord_situacion = 'P'
              AND o.ord_estado = 'D'
            ORDER BY o.ord_numero
        </qry:select>
        <qry:out>
            <qry:if left="#PARAM:/IMPINT_PARAM/INCOBRABLES/@PARAMINCOBRABLES" operator="equal" right="S" type="string">
                <qry:set-variable name="Imputacion_Incobrables" value="1"/>
            </qry:if>
            <qry:insert-query name="SeleccionaPersona" doc-param="#PARAM:"/>
            <qry:insert-query name="SeleccionaImpresora" doc-param="#PARAM:"/>
            <qry:insert-query name="CargaPlantillas" doc-param="#PARAM:"/>
            <qry:insert-query name="CargaProxNroProceso"/>
            <qry:if left="{$l_crr_genera_planilla}" operator="equal" right="0" type="string">
                <qry:set-variable name="l_crr_genera_planilla" value="N"/>
            </qry:if>
            <qry:insert-query name="SeleccionaFechaActual"/>
            <qry:insert-query name="SeleccionaEstadoInicial"/>
            <!-- INSERT Control de procesos salida-->
            <qry:element name="INSERT">
                <qry:text value="INSERT INTO control_procesos (cpr_numero,cpr_tipo_proceso,usr_numero_incorpora,prc_codigo,est_codigo,cpr_fecha_inicio) 
                                    VALUES({$l_cpr_numero}, 'IN', {$l_usr_numero}, 'IN', {$l_est_codigo}, {$sysdate}); "/>

                <qry:element name="control_procesos">
                    <qry:attribute name="cpr_numero" value="{$l_cpr_numero}"/>
                    <qry:attribute name="cpr_tipo_proceso" value="IN"/>
                    <qry:attribute name="usr_numero_incorpora" value="{$l_usr_numero}"/>
                    <qry:attribute name="prc_codigo" value="IN"/>
                    <qry:attribute name="est_codigo" value="{$l_est_codigo}"/>
                    <qry:attribute name="cpr_fecha_inicio" value="{$sysdate}"/>
                </qry:element>
            </qry:element>

            <qry:for-each-row>
                <qry:set-variable name="l_tor_descripcion" value="#ROW:/ROW/@TOR_DESCRIPCION"/>
                <qry:set-variable name="hay_datos_geograficos" value="0"/>
                <qry:element name="Main">
                    <qry:set-variable name="Tiene_Comprobantes_Financiaciones" value="0"/>
                    <qry:set-variable name="Tiene_Otros_Comprobantes" value="0"/>
                    <qry:if left="{#ROW:/ROW/@ORD_NUMERO}" operator="less" right="{$OrdenDesde}" type="integer">
                        <qry:set-variable name="OrdenDesde" value="{#ROW:/ROW/@ORD_NUMERO}"/>
                    </qry:if>
                    <qry:if left="{#ROW:/ROW/@ORD_NUMERO}" operator="greater" right="{$OrdenHasta}" type="integer">
                        <qry:set-variable name="OrdenHasta" value="{#ROW:/ROW/@ORD_NUMERO}"/>
                    </qry:if>

                    <qry:if left="{$sec_codigo}" operator="equal" right="0" type="integer">
                        <qry:if left="{#ROW:/ROW/@SEC_CODIGO_ORIGEN}" operator="not-equal" right="0" type="string">
                            <qry:set-variable name="sec_codigo" value="{#ROW:/ROW/@SEC_CODIGO_ORIGEN}"/>
                        </qry:if>
                    </qry:if>
                    <qry:if left="{$tor_grupo}" operator="equal" right="0" type="integer">
                        <qry:if left="{#ROW:/ROW/@TOR_GRUPO}" operator="not-equal" right="0" type="string">
                            <qry:set-variable name="tor_grupo" value="{#ROW:/ROW/@TOR_GRUPO}"/>
                        </qry:if>
                    </qry:if>

                    <qry:if left="{#ROW:/ROW/@SRV_CODIGO}" operator="equal" right="0" type="integer">
                        <qry:insert-query name="ObtenerDatosSinContrato" doc-param="#ROW:"/>
                    <qry:else/>
                        <qry:insert-query name="ObtenerDatosConContrato" doc-param="#ROW:"/>
                    </qry:if>
                    <qry:if left="{$hay_datos_geograficos}" operator="equal" right="0" type="integer">
                        <qry:insert-query name="ObtenerDatosSiNoHayDatos" doc-param="#ROW:"/>
                        <qry:if left="{$hay_datos_geograficos}" operator="equal" right="0" type="integer">
                            <qry:set-variable name="prs_num" value="0"/>
                        </qry:if>
                    </qry:if>

                    <qry:insert-query name="ObtenerNotCodigo" doc-param="#ROW:"/>
                    <qry:if left="{$not_codigo}" operator="not-equal" right="0" type="string">
                        <qry:set-variable name="ImporteDelAviso" value="0"/>
                        <qry:set-variable name="CantidadDeFacturas" value="0"/>

                        <!-- Proceso Principal -->
                        <qry:insert-query name="Notifi"/>
                        <qry:attribute name="CantidadDeFacturas" value="{$CantidadDeFacturas}"/>
                        <qry:if left="{$CantidadDeFacturas}" operator="greater" right="0" type="integer">
                            <qry:set-variable name="Escribi" value="1" operation="+"/>

                            <qry:insert-query name="GeneraArchivo" doc-param="#ROW:"/>

                            <qry:if left="{#ROW:/ROW/@TOR_GRUPO}" operator="equal" right="CD" type="string">
                                <qry:element name="UPDATE">
                                    <qry:text value="UPDATE ordenativos
                                                        SET ord_situacion = 'I'
                                                            ,cpr_numero = {$l_cpr_numero}
                                                        WHERE rowid = {#ROW:/ROW/@ROWID}; "/>

                                    <qry:element name="ordenativos">
                                        <qry:attribute name="cpr_numero" value="{$l_cpr_numero}"/>
                                        <qry:element name="WHERE">
                                            <qry:attribute name="rowid" value="{#ROW:/ROW/@ROWID}"/>
                                        </qry:element>
                                    </qry:element>
                                </qry:element>
                            <qry:else/>
                                <qry:element name="UPDATE">
                                    <qry:text value="UPDATE ordenativos
                                                        SET cpr_numero = {$l_cpr_numero}
                                                        WHERE rowid = {#ROW:/ROW/@ROWID}; "/>

                                    <qry:element name="ordenativos">
                                        <qry:attribute name="cpr_numero" value="{$l_cpr_numero}"/>
                                        <qry:element name="WHERE">
                                            <qry:attribute name="rowid" value="{#ROW:/ROW/@ROWID}"/>
                                        </qry:element>
                                    </qry:element>
                                </qry:element>
                            </qry:if>

                        <qry:else/>
                            <qry:attribute name="Imputacion_Incobrables" value="{$Imputacion_Incobrables}"/>
                            <qry:if left="{$Imputacion_Incobrables}" operator="not-equal" right="1" type="integer">
                                <qry:element name="UPDATE">
                                    <qry:text value="UPDATE ordenativos
                                                        SET ord_estado = 'A'
                                                        	,cpr_numero = {$l_cpr_numero}
                                                        	,ord_datos_anula = 'Anulado Documentos ya pagados - Saldo 0 - No se imprime  '
                                                        WHERE rowid = {#ROW:/ROW/@ROWID}; "/>

                                    <qry:element name="ordenativos">
                                        <qry:attribute name="ord_estado" value="A"/>
                                        <qry:attribute name="cpr_numero" value="{$l_cpr_numero}"/>
                                        <qry:attribute name="ord_datos_anula" value="Anulado Documentos ya pagados - Saldo 0 - No se imprime  "/>
                                        <qry:element name="WHERE">
                                            <qry:attribute name="rowid" value="{#ROW:/ROW/@ROWID}"/>
                                        </qry:element>
                                    </qry:element>
                                </qry:element>
                            </qry:if>
                        </qry:if>
                    </qry:if>
                </qry:element>
            </qry:for-each-row>

            <qry:if left="{$Escribi}" operator="not-equal" right="0" type="integer">
                <qry:element name="CMD">
                    <!-- <qry:text value="Imprime {#PARAM:/impint_param/NombreArchivo/@paramFile} list={#PARAM:/impint_param/Reporte/@paramRepCodigo}  id={#PARAM:/impint_param/User/@paramUser} dest={#PARAM:/impint_param/Print/@paramImpr} desc=\'P{$l_cpr_numero}_IMPINT_{$not_codigo}\'"/>-->
                </qry:element>
                <qry:element name="CMD">
                    <!-- <qry:text value="rm {#PARAM:/impint_param/NombreArchivo/@paramFile} "/>-->
                </qry:element>
            </qry:if>

            <qry:insert-query name="SeleccionaProxEstado"/>

            <!-- UPDATE Control de procesos salida-->
            <qry:element name="UPDATE">
                <qry:text value="UPDATE control_procesos 
                                    SET est_codigo = {$l_prox_est_codigo} 
                                    WHERE cpr_numero = {$l_cpr_numero}; "/>
                                    
                <qry:element name="control_procesos">
                    <qry:attribute name="est_codigo" value="{$l_prox_est_codigo}"/>
                    <qry:element name="WHERE">
                        <qry:attribute name="cpr_numero" value="{$l_cpr_numero}"/>
                    </qry:element>
                </qry:element>
            </qry:element>
            
            <qry:if left="{$l_crr_genera_planilla}" operator="equal" right="S" type="string">
                <qry:insert-query name="GrabaEnReportes"/>
            <qry:else/>
                <qry:if left="l_crr_genera_planilla" operator="equal" right="A" type="string">
                    <qry:insert-query name="GrabaEnReportes"/>
                    <qry:element name="CMD">
                        <qry:text value="Imprime %s list=IMPINT id=%s dest=%s desc=\'P%d_IMPINT_%s\'"/>
                    </qry:element>
                    <!-- Quilombo -->
                <qry:else/>
                    <!-- Quilombo -->
                </qry:if>
            </qry:if>
        </qry:out>
    </qry:query>

    <qry:query name="SeleccionaFechaActual" > 
        <qry:select>
            SELECT sysdate AS FECHA
            FROM DUAL
        </qry:select>
        <qry:out>
            <qry:for-each-row>
                <qry:set-variable name="sysdate" value="#ROW:/ROW/@FECHA"/>
            </qry:for-each-row>
        </qry:out>
    </qry:query>
    
    <qry:query name="SeleccionaPersona">
        <qry:select>
            SELECT usr_numero
            FROM usuarios
            WHERE usr_codigo = {#PARAM:/IMPINT_PARAM/USER/@PARAMUSER}
        </qry:select>
        <qry:out>
            <qry:for-each-row>
                <qry:set-variable name="l_usr_numero" value="#ROW:/ROW/@USR_NUMERO"/>
            </qry:for-each-row>
        </qry:out>
    </qry:query>

    <qry:query name="SeleccionaImpresora">
        <qry:select>
            SELECT tim_codigo
            FROM impresoras
            WHERE impresoras.prt_codigo = {#PARAM:/IMPINT_PARAM/PRINT/@PARAMIMPR}
        </qry:select>
        <qry:out>
            <qry:for-each-row>
                <qry:set-variable name="l_tim_codigo" value="#ROW:/ROW/@TIM_CODIGO"/>
            </qry:for-each-row>
        </qry:out>
    </qry:query>

    <qry:query name="CargaPlantillas">
        <qry:select>
            SELECT COALESCE(crr_genera_planilla, '0') AS CRR_GENERA_PLANILLA
            	,crr_archivo_sql
            	,crr_archivo_sql_path
            FROM correos c
            INNER JOIN usuarios u
            	ON c.scf_codigo = u.scf_codigo
            WHERE usr_codigo = {#PARAM:/IMPINT_PARAM/USER/@PARAMUSER}
            	AND crr_tipo = {#PARAM:/IMPINT_PARAM/TIPOCORREO/@PARAMCODTIPOCORREO}
            	AND crr_codigo = {#PARAM:/IMPINT_PARAM/CORREO/@PARAMCODCORREO}
        </qry:select>
        <qry:out>
            <qry:for-each-row>
                <qry:set-variable name="l_crr_genera_planilla" value="#ROW:/ROW/@CRR_GENERA_PLANILLA"/>
                <qry:set-variable name="l_crr_archivo_lote" value="#ROW:/ROW/@CRR_ARCHIVO_SQL"/>
                <qry:set-variable name="l_crr_archivo_lote_path" value="#ROW:/ROW/@CRR_ARCHIVO_SQL_PATH"/>
            </qry:for-each-row>
        </qry:out>
    </qry:query>

    <qry:query name="CargaProxNroProceso">
        <qry:select>
            SELECT cpr_numero.nextval AS CPR_NUMERO
            FROM sys.dual
        </qry:select>
        <qry:out>
            <qry:for-each-row>
                <qry:set-variable name="l_cpr_numero" value="#ROW:/ROW/@CPR_NUMERO"/>
            </qry:for-each-row>
        </qry:out>
    </qry:query>

    <qry:query name="SeleccionaEstadoInicial" > 
        <qry:select>
            SELECT fun_estado_inicial('IN') AS ESTADO
            FROM DUAL
        </qry:select>
        <qry:out>
            <qry:for-each-row>
                <qry:set-variable name="l_est_codigo" value="#ROW:/ROW/@ESTADO"/>
            </qry:for-each-row>
        </qry:out>
    </qry:query>

    <qry:query name="SeleccionaProxEstado" > 
        <qry:select>
            SELECT fun_proximo_estado('IN', {$l_est_codigo}, 'IM') AS PROX_ESTADO
            FROM DUAL
        </qry:select>
        <qry:out>
            <qry:for-each-row>
                <qry:set-variable name="l_prox_est_codigo" value="#ROW:/ROW/@PROX_ESTADO"/>
            </qry:for-each-row>
        </qry:out>
    </qry:query>

    <qry:query name="ObtenerDatosSinContrato" > 
        <qry:select  dump="0">
            SELECT personas.prs_numero
            	,substr(personas.prs_razon_social, 1, 25) AS PRS_RAZON_SOCIAL
            	,nvl(personas.prs_direccion, ' ') AS PRS_DIRECCION
            	,personas.cfc_codigo
            	,COALESCE(substr(calles.cll_nombre, 1, 18), '0') AS CLL_NOMBRE
            	,substr(nvl(personas.prs_nro, '    '), 1, 4) AS PRS_NRO
            	,substr(nvl(personas.prs_piso, '  '), 1, 2) AS PRS_PISO
            	,substr(nvl(personas.prs_depto, '   '), 1, 3) AS PRS_DEPTO
            	,nvl(personas.prs_torre, ' ') AS PRS_TORRE
            	,nvl(personas.prs_c_postal, ' ') AS PRS_C_POSTAL
            	,nvl(areas_geograficas.agf_nombre, ' ') AS AGF_NOMBRE
            FROM areas_geograficas 
            INNER JOIN personas 
            	ON areas_geograficas.agf_codigo = personas.agf_codigo
            INNER JOIN calles
            	ON calles.cll_codigo = personas.cll_codigo AND calles.agf_codigo = personas.agf_codigo
            WHERE personas.prs_numero = {#PARAM:/ROW/@PRS_NUMERO}
        </qry:select>
        <qry:out>
            <qry:for-each-row>
                <qry:set-variable name="hay_datos_geograficos" value="1" operation="+"/>

                <qry:set-variable name="prs_num" value="{#ROW:/ROW/@PRS_NUMERO}"/>
                <qry:set-variable name="prs_razon_social" value="{#ROW:/ROW/@PRS_RAZON_SOCIAL}"/>
                <qry:set-variable name="prs_direccion" value="{#ROW:/ROW/@PRS_DIRECCION}"/>
                <qry:set-variable name="cfc_codigo" value="{#ROW:/ROW/@CFC_CODIGO}"/>
                <qry:set-variable name="prs_calle" value="{#ROW:/ROW/@CLL_NOMBRE}"/>
                <qry:set-variable name="prs_nro" value="{#ROW:/ROW/@PRS_NRO}"/>
                <qry:set-variable name="prs_piso" value="{#ROW:/ROW/@PRS_PISO}"/>
                <qry:set-variable name="prs_depto" value="{#ROW:/ROW/@PRS_DEPTO}"/>
                <qry:set-variable name="prs_torre" value="{#ROW:/ROW/@PRS_TORRE}"/>
                <qry:set-variable name="prs_c_postal" value="{#ROW:/ROW/@PRS_C_POSTAL}"/>
                <qry:set-variable name="prs_agf_nombre" value="{#ROW:/ROW/@AGF_NOMBRE}"/>
            </qry:for-each-row>
        </qry:out>
    </qry:query>

    <qry:query name="ObtenerDatosConContrato" > 
        <qry:select  dump="0">
            SELECT personas.prs_numero
            	,substr(personas.prs_razon_social, 1, 25) AS PRS_RAZON_SOCIAL
            	,nvl(personas.prs_direccion, ' ') AS PRS_DIRECCION
            	,personas.cfc_codigo
            	,COALESCE(substr(calles.cll_nombre, 1, 18), '0') AS CLL_NOMBRE
            	,COALESCE(substr(contratos.cnt_nro_pago, 1, 4), '0') AS CNT_NRO_PAGO
            	,COALESCE(contratos.cnt_bis, '0') AS cnt_bis
            	,COALESCE(substr(contratos.cnt_piso_pago, 1, 2), '0') AS CNT_PISO_PAGO
            	,COALESCE(substr(contratos.cnt_depto_pago, 1, 3), '0') AS CNT_DEPTO_PAGO
            	,COALESCE(nvl(contratos.cnt_c_postal_pago, ' '), '0') AS CNT_C_POSTAL_PAGO
            	,nvl(areas_geograficas.agf_nombre, ' ') AS AGF_NOMBRE
            FROM areas_geograficas
            INNER JOIN contratos
            	ON areas_geograficas.agf_codigo = contratos.agf_codigo
            INNER JOIN personas
            	ON personas.prs_numero = contratos.prs_numero
            INNER JOIN calles
            	ON calles.agf_codigo = contratos.agf_codigo AND calles.cll_codigo = contratos.cll_codigo
            WHERE contratos.srv_codigo = {#PARAM:/ROW/@SRV_CODIGO}
            	AND contratos.cnt_numero = {#PARAM:/ROW/@CNT_NUMERO}
        </qry:select>
        <qry:out>
            <qry:for-each-row>
                <qry:set-variable name="hay_datos_geograficos" value="1" operation="+"/>

                <qry:set-variable name="prs_num" value="{#ROW:/ROW/@PRS_NUMERO}"/>
                <qry:set-variable name="prs_razon_social" value="{#ROW:/ROW/@PRS_RAZON_SOCIAL}"/>
                <qry:set-variable name="prs_direccion" value="{#ROW:/ROW/@PRS_DIRECCION}"/>
                <qry:set-variable name="cfc_codigo" value="{#ROW:/ROW/@CFC_CODIGO}"/>
                <qry:set-variable name="cll_nombre" value="{#ROW:/ROW/@CLL_NOMBRE}"/>
                <qry:set-variable name="cnt_nro_pago" value="{#ROW:/ROW/@CNT_NRO_PAGO}"/>
                <qry:set-variable name="cnt_bis" value="{#ROW:/ROW/@CNT_BIS}"/>
                <qry:set-variable name="cnt_piso_pago" value="{#ROW:/ROW/@CNT_PISO_PAGO}"/>
                <qry:set-variable name="cnt_depto_pago" value="{#ROW:/ROW/@CNT_DEPTO_PAGO}"/>
                <qry:set-variable name="cnt_c_postal_pago" value="{#ROW:/ROW/@CNT_C_POSTAL_PAGO}"/>
                <qry:set-variable name="cnt_agf_nombre" value="{#ROW:/ROW/@AGF_NOMBRE}"/>
            </qry:for-each-row>
        </qry:out>
    </qry:query>

    <qry:query name="ObtenerDatosSiNoHayDatos" > 
        <qry:select>
            SELECT personas.prs_numero
            	,substr(personas.prs_razon_social, 1, 25) AS PRS_RAZON_SOCIAL
            	,nvl(personas.prs_direccion, ' ') AS PRS_DIRECCION
            	,personas.cfc_codigo
            	,COALESCE(substr(nvl(regexp_replace(contratos.cnt_direccion_pago, '[[:space:]]+', chr(32)), ' '), 1, 27), '0') AS CNT_DIRECCION_PAGO
            FROM contratos
            INNER JOIN personas
            	ON personas.prs_numero = contratos.prs_numero
            WHERE contratos.srv_codigo = {#PARAM:/ROW/@srv_codigo}
            	AND contratos.cnt_numero = {#PARAM:/ROW/@cnt_numero}
        </qry:select>
        <qry:out>
            <qry:for-each-row>
               <qry:set-variable name="hay_datos_geograficos" value="1" operation="+"/>

               <qry:set-variable name="prs_num" value="{#ROW:/ROW/@PRS_NUMERO}"/>
               <qry:set-variable name="prs_razon_social" value="{#ROW:/ROW/@PRS_RAZON_SOCIAL}"/>
               <qry:set-variable name="prs_direccion" value="{#ROW:/ROW/@PRS_DIRECCION}"/>
               <qry:set-variable name="cfc_codigo" value="{#ROW:/ROW/@CFC_CODIGO}"/>
               <qry:set-variable name="cll_nombre_completo" value="{#ROW:/ROW/@CNT_DIRECCION_PAGO}"/>
            </qry:for-each-row>
        </qry:out>
    </qry:query>

    <qry:query name="ObtenerNotCodigo"> 
        <qry:select dump="0">
            SELECT COALESCE(not_codigo, '0') AS NOT_CODIGO
            FROM combinaciones_habilitadas_noti
            WHERE tor_codigo = {#PARAM:/ROW/@SRV_CODIGO}
            	AND cfc_codigo = {$cfc_codigo}
        </qry:select>
        <qry:out>
            <qry:for-each-row>
                <qry:set-variable name="not_codigo" value="{#ROW:/ROW/@NOT_CODIGO}"/>
            </qry:for-each-row>
        </qry:out>
    </qry:query>

</qry:doc-definition>